#!/usr/bin/env bash

# this is the worst script of all time
#
# i wish kitty remote control worked under tmux but it doesn't
# but running tmux under kitty is unsupported by the kitty developer
# so we have to resort to this crazy hack script

gutter_size=260

focus_mode_file=/tmp/FOCUS_MODE

### kitty helpers
kitty_conf_dir="$HOME/.config/kitty"
kitty_conf="$kitty_conf_dir/kitty.conf"

set_kitty_margin() {
    local value="$1"

    [ -f "$kitty_conf" ] || return

    # If the option exists, replace it; otherwise append it
    if grep -q "^[[:space:]]*window_margin_width[[:space:]]" "$kitty_conf"; then
        sed -i -E "s|^[[:space:]]*window_margin_width[[:space:]].*|window_margin_width ${value}|" "$kitty_conf"
    else
        printf '\n%s %s\n' "window_margin_width" "$value" >> "$kitty_conf"
    fi
}

reload_kitty_config() {
    # Prefer KITTY_PID if available
    if [ -n "${KITTY_PID-}" ] && kill -0 "$KITTY_PID" 2>/dev/null; then
        kill -SIGUSR1 "$KITTY_PID" 2>/dev/null || true
        return
    fi

    # Fallback: first kitty process
    local pid
    pid="$(pgrep -x kitty | head -n1 || true)"
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        kill -SIGUSR1 "$pid" 2>/dev/null || true
    fi
}

### tmux helpers
tmux_set_status() {
    tmux list-sessions -F '#S' | while read s; do
      tmux set-option -t "$s" status $1
    done
}


# focus mode on
if [ ! -f "$focus_mode_file" ]; then
    touch "$focus_mode_file"

    tmux_set_status off
    set_kitty_margin "0 $gutter_size 0"
    reload_kitty_config

 # focus mode off
else
    rm -f "$focus_mode_file"

    tmux_set_status on
    set_kitty_margin "0 0 0"
    reload_kitty_config

fi
